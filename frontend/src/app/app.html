<div class="app-container">
  <!-- Header -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>whatsapp</mat-icon>
        {{ title }}
      </mat-card-title>
      <mat-card-subtitle>
        Manage WhatsApp devices and send messages
      </mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <!-- Main Content -->
  <div class="content-container">
    <mat-tab-group>
      <!-- Device Management Tab -->
      <mat-tab label="Device Management">
        <div class="tab-content">
          <!-- Add New Device -->
          <mat-card class="form-card">
            <mat-card-header>
              <mat-card-title>Add New Device</mat-card-title>
              <mat-card-subtitle>Start a new WhatsApp device session</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="deviceForm" (ngSubmit)="startDevice()">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Device ID</mat-label>
                  <input matInput formControlName="deviceId" placeholder="e.g., device1, phone-01">
                  <mat-icon matSuffix>devices</mat-icon>
                  <mat-error *ngIf="deviceForm.get('deviceId')?.hasError('required')">
                    Device ID is required
                  </mat-error>
                  <mat-error *ngIf="deviceForm.get('deviceId')?.hasError('pattern')">
                    Device ID can only contain letters, numbers, dashes and underscores
                  </mat-error>
                </mat-form-field>

                <div class="form-actions">
                  <button mat-raised-button color="primary" type="submit"
                          [disabled]="deviceForm.invalid || isLoading()">
                    <mat-icon>add</mat-icon>
                    @if (isLoading()) {
                      <mat-spinner diameter="20"></mat-spinner>
                    } @else {
                      Start Device
                    }
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>

          <!-- Active Devices List -->
          <mat-card class="devices-card">
            <mat-card-header>
              <mat-card-title>Active Devices ({{ devices().length }})</mat-card-title>
              <mat-card-subtitle>Manage your WhatsApp device sessions</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              @if (devices().length === 0) {
                <div class="no-devices">
                  <mat-icon>devices_other</mat-icon>
                  <p>No devices added yet. Start by adding a new device above.</p>
                </div>
              } @else {
                <div class="devices-grid">
                  @for (device of devices(); track device.id) {
                    <mat-card class="device-card">
                      <mat-card-header>
                        <mat-card-title>{{ device.id }}</mat-card-title>
                        <mat-card-subtitle>
                          <mat-chip [color]="getDeviceStatusColor(device.status)">
                            <mat-icon>{{ getDeviceStatusIcon(device.status) }}</mat-icon>
                            {{ device.status === 'waiting_for_scan' ? 'Waiting for QR Scan' : (device.status | titlecase) }}
                          </mat-chip>
                        </mat-card-subtitle>
                      </mat-card-header>

                      @if (hasQRCode(device)) {
                        <mat-card-content class="qr-code-container">
                          <div class="qr-code-section">
                            <h4>Scan this QR Code with WhatsApp</h4>
                            <img [src]="device.qrCode" alt="WhatsApp QR Code" class="qr-code-image">
                            <p class="qr-instruction">
                              1. Open WhatsApp on your phone<br>
                              2. Go to Settings > Linked Devices<br>
                              3. Tap "Link a Device"<br>
                              4. Scan this QR code
                            </p>
                          </div>
                        </mat-card-content>
                      }

                      <mat-card-actions>
                        <button mat-button color="warn" (click)="removeDevice(device.id)">
                          <mat-icon>delete</mat-icon>
                          Remove
                        </button>
                      </mat-card-actions>
                    </mat-card>
                  }
                </div>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Send Messages Tab -->
      <mat-tab label="Send Messages">
        <div class="tab-content">
          <mat-card class="form-card">
            <mat-card-header>
              <mat-card-title>Send WhatsApp Message</mat-card-title>
              <mat-card-subtitle>Send text messages through your connected devices</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              @if (getAvailableDevices().length === 0) {
                <div class="no-devices">
                  <mat-icon>warning</mat-icon>
                  <p>No connected devices available. Please start a device first.</p>
                </div>
              } @else {
                <form [formGroup]="messageForm" (ngSubmit)="sendMessage()">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Select Device</mat-label>
                    <mat-select formControlName="deviceId">
                      @for (device of getAvailableDevices(); track device.id) {
                        <mat-option [value]="device.id">
                          {{ device.id }} ({{ device.status | titlecase }})
                        </mat-option>
                      }
                    </mat-select>
                    <mat-icon matSuffix>devices</mat-icon>
                    <mat-error *ngIf="messageForm.get('deviceId')?.hasError('required')">
                      Please select a device
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Phone Number</mat-label>
                    <input matInput formControlName="phoneNumber"
                           placeholder="e.g., +1234567890">
                    <mat-icon matSuffix>phone</mat-icon>
                    <mat-hint>Include country code (e.g., +1 for US)</mat-hint>
                    <mat-error *ngIf="messageForm.get('phoneNumber')?.hasError('required')">
                      Phone number is required
                    </mat-error>
                    <mat-error *ngIf="messageForm.get('phoneNumber')?.hasError('pattern')">
                      Please enter a valid phone number with country code
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Message</mat-label>
                    <textarea matInput formControlName="message"
                              placeholder="Enter your message here..."
                              rows="4"></textarea>
                    <mat-icon matSuffix>message</mat-icon>
                    <mat-error *ngIf="messageForm.get('message')?.hasError('required')">
                      Message is required
                    </mat-error>
                    <mat-error *ngIf="messageForm.get('message')?.hasError('minlength')">
                      Message cannot be empty
                    </mat-error>
                  </mat-form-field>

                  <div class="form-actions">
                    <button mat-raised-button color="primary" type="submit"
                            [disabled]="messageForm.invalid || isLoading()">
                      <mat-icon>send</mat-icon>
                      @if (isLoading()) {
                        <mat-spinner diameter="20"></mat-spinner>
                      } @else {
                        Send Message
                      }
                    </button>
                  </div>
                </form>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- API Documentation Tab -->
      <mat-tab label="API Documentation">
        <div class="tab-content">
          <mat-card class="docs-card">
            <mat-card-header>
              <mat-card-title>API Endpoints</mat-card-title>
              <mat-card-subtitle>Available WhatsApp API endpoints</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="api-endpoint">
                <h3>Start Device Session</h3>
                <code>POST /api/devices/:id/start</code>
                <p>Start a new WhatsApp device session. This will generate a QR code that needs to be scanned.</p>
              </div>

              <div class="api-endpoint">
                <h3>Send Message</h3>
                <code>POST /api/devices/:id/send</code>
                <p>Send a text message through the specified device.</p>
                <strong>Body:</strong>
                <pre>{{ '{' }}
  "to": "1234567890&#64;s.whatsapp.net",
  "message": "Hello, World!"
{{ '}' }}</pre>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- System Monitoring Tab -->
      <mat-tab label="System Monitor">
        <div class="tab-content">
          @if (systemInfo()) {
            <!-- System Overview -->
            <mat-card class="system-overview-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>computer</mat-icon>
                  System Overview
                  @if (systemLoading()) {
                    <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
                  }
                </mat-card-title>
                <mat-card-subtitle>
                  {{ systemInfo()!.hostname }} - {{ systemInfo()!.platform }} {{ systemInfo()!.arch }}
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="system-stats">
                  <div class="stat-item">
                    <mat-icon>schedule</mat-icon>
                    <div class="stat-content">
                      <h4>Uptime</h4>
                      <p>{{ formatUptime(systemInfo()!.uptime) }}</p>
                    </div>
                  </div>

                  <div class="stat-item">
                    <mat-icon>memory</mat-icon>
                    <div class="stat-content">
                      <h4>Total Memory</h4>
                      <p>{{ formatBytes(systemInfo()!.totalmem) }}</p>
                    </div>
                  </div>

                  <div class="stat-item">
                    <mat-icon>developer_board</mat-icon>
                    <div class="stat-content">
                      <h4>CPU</h4>
                      <p>{{ systemInfo()!.cpu.brand }}</p>
                      <small>{{ systemInfo()!.cpu.cores }} cores &#64; {{ systemInfo()!.cpu.speed }}GHz</small>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Resource Usage -->
            <div class="resource-cards">
              <!-- CPU Usage -->
              <mat-card class="resource-card">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>speed</mat-icon>
                    CPU Usage
                  </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="usage-info">
                    <h3>{{ systemInfo()!.cpu.currentLoad.toFixed(1) }}%</h3>
                    <mat-progress-bar
                      mode="determinate"
                      [value]="systemInfo()!.cpu.currentLoad"
                      [color]="getPercentageColor(systemInfo()!.cpu.currentLoad)">
                    </mat-progress-bar>
                  </div>
                  <div class="cpu-details">
                    <p><strong>User:</strong> {{ systemInfo()!.cpu.currentLoad.toFixed(1) }}%</p>
                    <p><strong>Average Load:</strong> {{ systemInfo()!.cpu.avgLoad.toFixed(2) }}</p>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- Memory Usage -->
              <mat-card class="resource-card">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>memory</mat-icon>
                    Memory Usage
                  </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="usage-info">
                    <h3>{{ systemInfo()!.memory.usagePercent }}%</h3>
                    <mat-progress-bar
                      mode="determinate"
                      [value]="parseFloat(systemInfo()!.memory.usagePercent)"
                      [color]="getPercentageColor(parseFloat(systemInfo()!.memory.usagePercent))">
                    </mat-progress-bar>
                  </div>
                  <div class="memory-details">
                    <p><strong>Used:</strong> {{ formatBytes(systemInfo()!.memory.used) }}</p>
                    <p><strong>Free:</strong> {{ formatBytes(systemInfo()!.memory.free) }}</p>
                    <p><strong>Available:</strong> {{ formatBytes(systemInfo()!.memory.available) }}</p>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>

            <!-- Process Information -->
            <mat-card class="processes-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>list</mat-icon>
                  Process Information
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="process-summary">
                  <mat-chip-set>
                    <mat-chip>Total: {{ systemInfo()!.processes.all }}</mat-chip>
                    <mat-chip color="primary">Running: {{ systemInfo()!.processes.running }}</mat-chip>
                    <mat-chip color="accent">Sleeping: {{ systemInfo()!.processes.sleeping }}</mat-chip>
                    <mat-chip color="warn">Blocked: {{ systemInfo()!.processes.blocked }}</mat-chip>
                  </mat-chip-set>
                </div>

                <mat-expansion-panel>
                  <mat-expansion-panel-header>
                    <mat-panel-title>Top Processes</mat-panel-title>
                    <mat-panel-description>CPU and memory usage by process</mat-panel-description>
                  </mat-expansion-panel-header>

                  <div class="process-list">
                    @for (process of systemInfo()!.processes.list; track process.pid) {
                      <div class="process-item">
                        <div class="process-info">
                          <strong>{{ process.name }}</strong>
                          <small>PID: {{ process.pid }}</small>
                        </div>
                        <div class="process-stats">
                          <span class="cpu-stat">CPU: {{ process.cpu.toFixed(1) }}%</span>
                          <span class="mem-stat">MEM: {{ process.mem.toFixed(1) }}%</span>
                        </div>
                      </div>
                    }
                  </div>
                </mat-expansion-panel>
              </mat-card-content>
            </mat-card>

            <!-- Network Information -->
            <mat-card class="network-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>network_check</mat-icon>
                  Network Interfaces
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="network-list">
                  @for (net of systemInfo()!.network; track net.iface) {
                    <div class="network-item">
                      <div class="network-info">
                        <strong>{{ net.iface }}</strong>
                        <mat-chip [color]="net.operstate === 'up' ? 'primary' : 'warn'">
                          {{ net.operstate }}
                        </mat-chip>
                      </div>
                      <div class="network-stats">
                        <p><strong>RX:</strong> {{ formatBytes(net.rx_bytes) }} ({{ formatBytes(net.rx_sec) }}/s)</p>
                        <p><strong>TX:</strong> {{ formatBytes(net.tx_bytes) }} ({{ formatBytes(net.tx_sec) }}/s)</p>
                      </div>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          } @else if (systemLoading()) {
            <div class="loading-container">
              <mat-spinner></mat-spinner>
              <p>Loading system information...</p>
            </div>
          } @else {
            <mat-card class="error-card">
              <mat-card-content>
                <div class="error-message">
                  <mat-icon>error</mat-icon>
                  <h3>Failed to load system information</h3>
                  <p>Unable to fetch system monitoring data. Please check if the backend is running.</p>
                </div>
              </mat-card-content>
            </mat-card>
          }
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
